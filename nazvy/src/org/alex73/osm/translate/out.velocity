<!DOCTYPE html>
<html lang="be" ng-app>
<head>
    <meta charset="UTF-8">
    
    <script type = "text/javascript" src = "http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.4/angular.min.js"></script>
    <script src="${typ}.js"></script>
        
    <style type="text/css">
        body {
            font-family: sans-serif;
            font-size: 80%;
        }
        table {
            border-collapse: collapse;
        }
        td, th {
            border: 1px solid black;
        }
    </style>
    <title>Пераклад ${typ}</title>
</head>
<body ng-controller="Page">

<b><u>Пераклад ад ${currentDateTime}</u></b> <br/><br/>

#set ( $quo = "$")
<script language="javascript">
    function sendAll() {
      ${quo}.ajax("http://127.0.0.1:8111/version",{
        async: false
      }).done(function( data ) {
        if (data.protocolversion.major<2 && data.protocolversion.minor<7) {
          alert("У вас занадта стары JOSM. Карыстайцеся вэрсіяй не менш за 7680");
        } else {
          sendAllChecked();
        }
      }).fail(function(jq,status,error) {
        alert("Памылка запыту вэрсіі JOSM. Можа ён не стартаваны ці не дазволены Remote Control ?\n\n "+error);
      });
    }
    function sendAllChecked() {
      for(i=0; i<scope.rows.length; i++) {
        var send="";
        for(j=0; j<scope.table.attributes.length; j++) {
          if (scope.checked[i][j]) {
            send += '|' + scope.table.attributes[j] + '=' + scope.rows[i].tags[j].nv;
            scope.checked[i][j] = false;
          }
        }
        if (send) {
          ${quo}.ajax({
              url: "http://127.0.0.1:8111/load_object?objects="+scope.rows[i].id+"&addtags="+send.substring(1),
              async: false
              }).done(function( data ) {
                scope.${quo}apply(function() {
                  for(j=0; j<scope.table.attributes.length; j++) {
                    scope.checked[i][j] = false;
                  }
                });
              }).fail(function(jq,status,error) {
                alert("Памылка запыту JOSM:\n\n"+error);
                i = 999999999;
              });
        }
      }
    }

var scope;
    function Page(${quo}scope) {
      scope = ${quo}scope;
      scope.table = table;
      
      scope.listRegions = new Array();
      scope.listRegions.push({id: -1, name: "Усе - "+table.rowsCount});
      for(i=0; i<table.regions.length; i++) {
        scope.listRegions.push({id: i, name: table.regions[i].name+" - "+table.regions[i].rows.length});
      }
      
      scope.updateRegion = function() {
        var prepared;
        if (scope.selectedRegionIndex == -1) {
          prepared = new Array();
          for(i=0; i<table.regions.length; i++) {
            var a=table.regions[i].rows;
            for(j=0;j<a.length;j++) {
              prepared.push(a[j]);
            }
          }
        } else {
          prepared = table.regions[scope.selectedRegionIndex].rows;
        }
        scope.rows = prepared;
        scope.checked = new Array();
        for(i=0; i<scope.rows.length; i++) {
          scope.checked[i]=new Array();
        }
      };
      scope.id2link = function(id) {
        var p = id.replace('n','node/').replace('w','way/').replace('r','relation/');
        return "https://www.openstreetmap.org/"+p+"/history";
      };
      scope.styleForCell = function(rowIndex,colIndex) {
        if (scope.checked[rowIndex][colIndex]) {
          return "background: #80FFFF";
        }
        var tag=scope.rows[rowIndex].tags[colIndex];
        if (tag.ov == tag.nv) {
          return '';
        } else if (tag.ov == '') {
          return "background: #FFFF80";
        } else {
          return "background: #FF8080";
        }
      };
      scope.setSelectedCol = function(col, val) {
        for(i=0; i<scope.rows.length; i++) {
          var tag=scope.rows[i].tags[col];
          if (tag.nv != '' && tag.ov != tag.nv) {
            scope.checked[i][col] = val;
          }
        }
      };
      scope.setSelectedRow = function(row, val) {
        for(j=0; j<scope.table.attributes.length; j++) {
          var tag=scope.rows[row].tags[j];
          if (tag.nv != '' && tag.ov != tag.nv) {
            scope.checked[row][j] = val;
          }
        }
      };
    }
</script>

<div style="position: fixed; right: 50px; top: 25px; background-color: white; border-style: solid; border-color: red">
Спачатку дашліце некалькі аб'ектаў каб пазначыць "Accept All Tags"<br/>
<button onClick="javascript: sendAll();">Даслаць у JOSM</button>
</div>

Калі жадаеце дапамагчы з перакладам,
пішыце на <a href="http://forum.openstreetmap.org/viewforum.php?id=35">форум</a> ці <a href="mailto:alex73mail@gmail.com">пошту</a>.

<br/>
<select ng-model="selectedRegionIndex" ng-change="updateRegion()" ng-options="item.id as item.name for item in listRegions"></select>

<table>
  <thead>
    <th>Назва</td>
    <th ng-repeat="attr in table.attributes">
      {{attr}}
      <a href="" ng-click="setSelectedCol(${quo}index, true)">+</a>
      <a href="" ng-click="setSelectedCol(${quo}index, false)">-</a>
    </td>
  </thead>
  <tr ng-repeat="row in rows" ng-init="rowIndex = ${quo}index">
    <td>
      <a href="{{id2link(row.id)}}" target="_blank">o</a>
      {{row.name}}
      <a href="" ng-click="setSelectedRow(rowIndex, true)">+</a>
      <a href="" ng-click="setSelectedRow(rowIndex, false)">-</a>
    </td>
    <td ng-init="colIndex = ${quo}index; tag = row.tags[${quo}index]" ng-repeat="attr in table.attributes" style="{{styleForCell(rowIndex,colIndex)}}">
      <span ng-if="tag.ov == tag.nv">{{tag.ov}}</span>
      <span ng-if="tag.ov != tag.nv">
        <input ng-if="tag.nv != ''" type="checkbox" ng-model="checked[rowIndex][colIndex]"></input>
        {{row.tags[colIndex].ov}} -> {{row.tags[colIndex].nv}}
      </span>
    </td>
  </tr>
</table>

</body>
</html>
