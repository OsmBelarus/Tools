<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="osm">

  <resultMap type="org.alex73.osm.validators.vulicy2.OsmNamed" id="OsmNamed" />

  <resultMap type="org.alex73.osm.validators.vulicy2.OsmPlace" id="OsmPlace" />

  <sql id="fieldsNamed">
       tags->'name' as name,
       tags->'name:be' as name_be,
       tags->'name:be-tarask' as name_be_tarask,
       tags->'name:ru' as name_ru,
       tags->'int_name' as int_name,
       tags->'alt_name' as alt_name,
       tags->'alt_name:be' as alt_name_be,
       tags->'alt_name:ru' as alt_name_ru
  </sql>
  <sql id="fieldsPlace">
       <include refid="fieldsNamed"/>,
       tags->'place' as place,
       tags->'addr:country' as addr_country,
       tags->'addr:region' as addr_region,
       tags->'addr:district' as addr_district,
       tags->'population' as population,
       tags->'population_date' as population_date,
       ST_AsEWKT(geom) as geom_text
  </sql>

  <select id="getPlaces" resultMap="OsmPlace">
      SELECT id, type, <include refid="fieldsPlace"/>
        FROM geo_cities
  </select>

  <select id="getPlaceByNodeId" parameterType="long" resultMap="OsmPlace">
      SELECT id, type, <include refid="fieldsPlace"/>
        FROM geo_cities
       WHERE id = #{value} AND type='NODE'
  </select>
  <select id="getPlaceByWayId" parameterType="long" resultMap="OsmPlace">
      SELECT id, type, <include refid="fieldsPlace"/>
        FROM geo_cities
       WHERE id = #{value} AND type='WAY'
  </select>
  <select id="getPlaceByRelationId" parameterType="long" resultMap="OsmPlace">
      SELECT id, type, <include refid="fieldsPlace"/>
        FROM geo_cities
       WHERE id = #{value} AND type='RELATION'
  </select>

  <select id="getStreetsInsideGeom" parameterType="long" resultMap="OsmNamed">
    SELECT id, 'WAY' as type, <include refid="fieldsNamed"/>
        FROM (
          SELECT *
            FROM geo_roads
           WHERE tags->'highway' NOT IN ('raceway','cycleway','path') AND
             NOT exist_key(tags, 'int_ref') AND
             NOT exist_key(tags, 'ref')
        ) as w
       WHERE ST_Intersects(geom, ST_GeomFromEWKT(#{value}))
  </select>
  <select id="getHousesInsideGeom" parameterType="long" resultMap="OsmNamed">
    SELECT id, 'WAY' as type,
           tags->'addr:street' as name,
           tags->'addr:street:be' as name_be
        FROM (
          SELECT *
            FROM geo_houses
           WHERE exist_key(tags, 'addr:street')
        ) as w
       WHERE ST_Intersects(geom, ST_GeomFromEWKT(#{value}))
  </select>
  <select id="getAddressesInsideGeom" parameterType="long" resultMap="OsmNamed">
    SELECT id, 'RELATION' as type, <include refid="fieldsNamed"/>
        FROM geo_address_streets r
       WHERE ST_Intersects(geom, ST_GeomFromEWKT(#{value}))
  </select>
  
  <!-- Мяжа вакол кропкі горада: вяртае найменьшы палігон вакол кропкі з вызначаным place -->
  <select id="city_border">
     SELECT a.osm_id, a.name, a."name:be", a.place
       FROM osm_polygon a, osm_point p
      WHERE ST_Contains(a.way, p.way) AND 
            p.osm_id=#{cityId} AND 
            a.place IN ('city','town','village','hamlet','isolated_dwelling')
      ORDER BY ST_Area(a.way)
  </select>
  
</mapper>
